# 技术原理分析
数据表设计，各个数据表的字段是怎样的，用处是什么，有哪些精妙的设计？        
主要有几个资源管理，客服资源、客户资源、问候语、常见问题、下班等细节问题。      
客户与客服对话的前后端交互式怎么样的，Workerman是怎么进行消息分发的。   
聊天框部署，标准及迷你窗口、生成js、生成HTML、微信公众号链接、客服专属链接。        

公众号专属链接应该还会获取微信用户信息，这一点非常不错，可以让微信用户持久化，后续访问后台都能追踪。  


后台模块控制器中，最关键的一个核心类就是这个。    
包含了所有的消息接收、图片、文件上传等等之类的逻辑。  
application\admin\controller\Event.php    


# 用户端与客服对话流程分析
聊天框样式有标准窗口合迷你窗口两种。    
部署的形式有生成JS、生成HTML、生成微信公众号链接、生成我的专属链接。          

**标准窗口的部署**
```php
//**********************************************
// 生成 JS
//**********************************************
<script src="http://customerservice.test/assets/front/dianqilai_1.js?v=1600930230"></script>
// 如果需要添加自身网站用户数据，则需如下操作：
<script >
  dianqilai.visiter_id='';//访客id
  dianqilai.visiter_name='';//访客昵称
  dianqilai.avatar='';//访客头像绝对路径
  dianqilai.product='{}';//json数据字符串
</script>
/**
 *格式如下：
 * {"pid":1,"title":" Apple MacBook Air ","img":"http://www.dianqilai.com/assets/images/pro.jpg","info":"13.3英寸笔记本电脑 银色(2017款Core i5 处理器/8GB内存/128GB闪存 MQD32CH/A)","price":"￥7588.00","url":"http://www.dianqilai.com/demo/index/product1"}
*/


//**********************************************
// 生成 HTML
//**********************************************
<link rel='stylesheet' href='http://customerservice.test/assets/css/index/dianqilai_online.css'>
<div class="dianqilai-form" id="dianqilai-kefu" >
  <i class="dianqilai-icon"></i>
  <form class="dianqilai-item" action="http://customerservice.test/index/index/home?visiter_id=&visiter_name=&avatar=&business_id=1&groupid=0" method="post" target="_blank" >
  <input type="hidden" name="product" value=''>
  <input type="submit" value='在线咨询'>
  </form>
</div>


//**********************************************
// 生成微信公众号链接
//**********************************************
// 通用分组
// http://customerservice.test/index/index/wechat/business_id/1/groupid/0.html


//**********************************************
// 生成我的专属链接
//**********************************************
// http://customerservice.test/index/index/home?visiter_id=&visiter_name=&avatar=&business_id=1&groupid=0&special=1
```

**迷你窗口的部署**
```php
//**********************************************
// 生成 JS
//**********************************************
http://customerservice.test/index/index/home?visiter_id=&visiter_name=&avatar=&business_id=1&groupid=0&special=1
<script src="http://customerservice.test/assets/layer/dianqilai_1.js"></script>
// 如果需要添加自身网站用户数据，则需如下操作：
<script >
  dianqilai.visiter_id='';//访客id
  dianqilai.visiter_name='';//访客昵称
  dianqilai.avatar='';//访客头像绝对路径
  dianqilai.product='{}';//json数据字符串
</script>
/**
 * 格式如下：
 * {"pid":1,"title":" Apple MacBook Air ","img":"http://www.dianqilai.com/assets/images/pro.jpg","info":"13.3英寸笔记本电脑 银色(2017款Core i5 处理器/8GB内存/128GB闪存 MQD32CH/A)","price":"￥7588.00","url":"http://www.dianqilai.com/demo/index/product1"}
*/
```


## JS部署模式
每个客服的js文件都不同，每部署一次这样的形式，就会生成一个js文件。  
**标准窗口**
```php
// 文件地址 public\assets\front\dianqilai_1.js
// 源码有点长，就不详细贴了，这里大概说一下流程。
// 加载css代码，创建【在线咨询】元素，添加到页面中。
// 点击在线咨询时，会
<i class="dianqilai-icon"></i><p class="dianqilai-item" onclick="dianqilai.blank(0)" >在线咨询</p>
<script>
  var dianqilai ={
    visiter_id:'', // 访客ID
    visiter_name:'', // 访客昵称
    avatar:'', // 访客头像 绝对路径
    product:'', // 附加的数据

    blank:function(groupid){
      var web =encodeURI('http://customerservice.test/index/index/home?visiter_id='+this.visiter_id+'&visiter_name='+this.visiter_name+'&avatar='+this.avatar+'&business_id=1&groupid='+groupid+'&product='+this.product);

      var moblieweb = encodeURI('http://customerservice.test/mobile/index/home?visiter_id='+this.visiter_id+'&visiter_name='+this.visiter_name+'&avatar='+this.avatar+'&business_id=1&groupid='+groupid+'&product='+this.product);

      if ((navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i))) {
        window.open(moblieweb); 
      }else{
        window.open(web); 
      }
    },
  }
</script>

// 最后访问到 /index/index/home /mobile/index/home
// 携带参数  visiter_id, visiter_name, avatar, groupid, product, business_id 
// application\index\controller\Index.php home()
// application\mobile\controller\Index.php home()

```

**迷你窗口**
```js
// 文件地址 public\assets\layer\dianqilai_1.js
connenct:function(groupid){
  var id =groupid;
  var web =encodeURI('http://customerservice.test/layer?visiter_id='+this.visiter_id+'&visiter_name='+this.visiter_name+'&avatar='+this.avatar+'&business_id=1&groupid='+groupid+'&product='+this.product);

  .....
  div.innerHTML='<i class="dianqilai-close" onclick="dianqilai.narrow()"></i><iframe id="wolive-iframe" src="'+web+'"></iframe>'
},
// 最后访问到 /layer/index/index
// 迷你窗口手机端没有差异，只有PC端有不同
// PC端利用 iframe 来加载第三方网站地址，非常的优秀。    
```