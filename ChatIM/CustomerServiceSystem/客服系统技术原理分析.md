# 技术原理分析

数据表设计，各个数据表的字段是怎样的，用处是什么，有哪些精妙的设计？      
主要有几个资源管理，客服资源、客户资源、问候语、常见问题、下班等细节问题。      
客户与客服对话的前后端交互式怎么样的，Workerman 是怎么进行消息分发的。      
聊天框部署，标准及迷你窗口、生成 js、生成 HTML、微信公众号链接、客服专属链接。      

公众号专属链接应该还会获取微信用户信息，这一点非常不错，可以让微信用户持久化，后续访问后台都能追踪。    

后台模块控制器中，最关键的一个核心类就是这个。      
包含了所有的消息接收、图片、文件上传等等之类的逻辑。  
application\admin\controller\Event.php    

前后端消息推送使用`pusher`库    
前端 JS 库 https://github.com/pusher/pusher-js      
后端 PHP 库 https://github.com/pusher/pusher-http-php     

其他的还用到了浏览器通知 notify.js、音视频 webrtc 等，=_= JS 代码看的我懵逼了。     

之前以为 `application\admin\controller\Event.php` 是跟访客端的websocket的信息分发，看了 `public\assets\js\index\inchat.js` 的代码之后，
发现都只是向 Event.php 请求数据而已，当做接口用了。而原来的 `application\api` 接口模块基本上没有写几行代码。  

# Pusher 库前后端交互
```php
//***************************************************
// 后端消息发布
//***************************************************
$app_key = app_key;
$app_secret = app_secret;
$app_id = app_id;
$options = array( 'encrypted' => $state);
$host = ahost;
$port = aport;

$pusher = new Pusher($app_key, $app_secret, $app_id, $options, $host, $port);
$pusher->trigger("kefu" . $post['id'], "video", array("message" => "申请视频连接", "channel" => $post['channel'], "avatar" => $post['avatar'], 'username' => $post['name'], "cid" => $post['cha']));


//***************************************************
// 前端消息订阅
//***************************************************
$channel = bin2hex($visiter_id . '/' . $business_id);
var channel= '{$channel}';
var pusher = new Pusher('{$app_key}', {
    encrypted: {$value},
    enabledTransports: ['ws'],
    wsHost: '{$whost}',
    {$port}: {$wport},
    authEndpoint: HJWEB_ROOT_URL + '/admin/login/auth',
    disableStats: true
});
var channels = pusher.subscribe("cu" + channel); // 订阅指定频道 
channels.bind('my-event', function (data) {}); // 接收消息
// pusher 连接状态监听       
pusher.connection.bind('state_change', function(states) {
    if(states.current == 'unavailable' || states.current == "disconnected" || states.current == "failed" ){
        $.cookie("cid","");
        var id =$.cookie("services");
        if(id){
          pusher.unsubscribe("se"+id);
        }
        pusher.unsubscribe("cu" + channel);

        if (typeof pusher.isdisconnect == 'undefined') {
        pusher.isdisconnect = true;
        pusher.disconnect();
          delete pusher;
        window.setTimeout(function(){
            wolive_connect();
        },1000);
      }
    }
});
pusher.connection.bind('connected', function() {
    $.cookie("cid","");
});
```


#  API接口类 application\admin\controller\Event.php 分析
这个类主要作为访客端获取数据的API接口，很多业务逻辑都在这里写了。前端通过ajax请求来访问。      

* `/admin/event/index`  离线，在线监控类
* `/admin/event/registerApi`  注册接口
* `/admin/event/push`  微信前台对话pusher类
* `/admin/event/notice`  前台寻求客服对话类
* `/admin/event/upload`  图片上传
* `/admin/event/uploadfile`  文件上传
* `/admin/event/chatdata`  获取最近对话信息
* `/admin/event/qdelete`  删除访客信息
* `/admin/event/apply`  客服申请视频通话  
* `/admin/event/refuse`  拒绝访客端视频通话请求
* `/admin/event/getquestion` 获取常见问题 
* `/admin/event/getanswer` 获取指定问题的回复
* `/admin/event/groupNum`  获取客服分组数量
* `/admin/event/getchangekefu` 转接访客的客服
* `/admin/event/gettablist`  获取访客窗口页右侧Tab 
* `/admin/event/uploadimg`  接收图片上传
* `/admin/event/uploadVoice`  接收音频上传
* `/admin/event/getwaitnum`   获取访客排队的数量
* `/admin/event/comment`  访客提交客服评价
* `/admin/event/info`  客服离线时，访客提交个人信息



# 用户端与客服对话流程分析

聊天框样式有标准窗口合迷你窗口两种。  
部署的形式有生成 JS、生成 HTML、生成微信公众号链接、生成我的专属链接。

**标准窗口的部署**

```php
//**********************************************
// 生成 JS
//**********************************************
<script src="http://customerservice.test/assets/front/dianqilai_1.js?v=1600930230"></script>
// 如果需要添加自身网站用户数据，则需如下操作：
<script >
  dianqilai.visiter_id='';//访客id
  dianqilai.visiter_name='';//访客昵称
  dianqilai.avatar='';//访客头像绝对路径
  dianqilai.product='{}';//json数据字符串
</script>
/**
 *格式如下：
 * {"pid":1,"title":" Apple MacBook Air ","img":"http://www.dianqilai.com/assets/images/pro.jpg","info":"13.3英寸笔记本电脑 银色(2017款Core i5 处理器/8GB内存/128GB闪存 MQD32CH/A)","price":"￥7588.00","url":"http://www.dianqilai.com/demo/index/product1"}
*/


//**********************************************
// 生成 HTML
//**********************************************
<link rel='stylesheet' href='http://customerservice.test/assets/css/index/dianqilai_online.css'>
<div class="dianqilai-form" id="dianqilai-kefu" >
  <i class="dianqilai-icon"></i>
  <form class="dianqilai-item" action="http://customerservice.test/index/index/home?visiter_id=&visiter_name=&avatar=&business_id=1&groupid=0" method="post" target="_blank" >
  <input type="hidden" name="product" value=''>
  <input type="submit" value='在线咨询'>
  </form>
</div>


//**********************************************
// 生成微信公众号链接
//**********************************************
// 通用分组
http://customerservice.test/index/index/wechat/business_id/1/groupid/0.html


//**********************************************
// 生成我的专属链接
//**********************************************
http://customerservice.test/index/index/home?visiter_id=&visiter_name=&avatar=&business_id=1&groupid=0&special=1
```

**迷你窗口的部署**

```php
//**********************************************
// 生成 JS
//**********************************************
http://customerservice.test/index/index/home?visiter_id=&visiter_name=&avatar=&business_id=1&groupid=0&special=1
<script src="http://customerservice.test/assets/layer/dianqilai_1.js"></script>
// 如果需要添加自身网站用户数据，则需如下操作：
<script >
  dianqilai.visiter_id='';//访客id
  dianqilai.visiter_name='';//访客昵称
  dianqilai.avatar='';//访客头像绝对路径
  dianqilai.product='{}';//json数据字符串
</script>
/**
 * 格式如下：
 * {"pid":1,"title":" Apple MacBook Air ","img":"http://www.dianqilai.com/assets/images/pro.jpg","info":"13.3英寸笔记本电脑 银色(2017款Core i5 处理器/8GB内存/128GB闪存 MQD32CH/A)","price":"￥7588.00","url":"http://www.dianqilai.com/demo/index/product1"}
*/
```


## JS 部署模式
每个客服的 js 文件都不同，每部署一次这样的形式，就会生成一个 js 文件。

### 标准窗口

```php
// 文件地址 public\assets\front\dianqilai_1.js
// 源码有点长，就不详细贴了，这里大概说一下流程。
// 加载css代码，创建【在线咨询】元素，添加到页面中。
// 点击在线咨询时，会
<i class="dianqilai-icon"></i><p class="dianqilai-item" onclick="dianqilai.blank(0)" >在线咨询</p>
<script>
  var dianqilai ={
    visiter_id:'', // 访客ID
    visiter_name:'', // 访客昵称
    avatar:'', // 访客头像 绝对路径
    product:'', // 附加的数据

    blank:function(groupid){
      var web =encodeURI('http://customerservice.test/index/index/home?visiter_id='+this.visiter_id+'&visiter_name='+this.visiter_name+'&avatar='+this.avatar+'&business_id=1&groupid='+groupid+'&product='+this.product);

      var moblieweb = encodeURI('http://customerservice.test/mobile/index/home?visiter_id='+this.visiter_id+'&visiter_name='+this.visiter_name+'&avatar='+this.avatar+'&business_id=1&groupid='+groupid+'&product='+this.product);

      if ((navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i))) {
        window.open(moblieweb);
      }else{
        window.open(web);
      }
    },
  }
</script>

// 最后访问到 /index/index/home /mobile/index/home
// 携带参数  visiter_id, visiter_name, avatar, groupid, product, business_id
// application\index\controller\Index.php home()
// application\mobile\controller\Index.php home()
// 微信授权登录页面 /index/index/wechat 会根据 business_id 公司ID获取对应的公众号配置，然后跳转用户授权登录页面
// 获取上面的携带参数，并且检测是否是微信浏览器并且带了code，是则进行微信用户授权登录获取用户信息
// 然后跳转 /index/index/index 页面

// /index/index/index 对话窗口页面分析，对话窗口页面，手机端和PC端的逻辑大致一样
// 其他的都是增删改查的东西，数据表设计好之后就容易做出来。这个交互是最复杂的，要专注一心，好好思考。
// 访客访问之后存入 SESSION 的数据
array (size=1)
  'Custom' =>
    array (size=1)
      'visiter_id' => string '5f6d5656' (length=8)

// 对话窗口页面action
// =_= 这么重要的页面，被if...else搞成一坨翔了，真是晕倒啊。代码可读性变得非常非常的差。
public function index()
{
    // application\extra\push\Pusher.php
    $pusher = new Pusher($app_key, $app_secret, $app_id, $options, $host, $port); // 新建Pusher

    $arr = $this->request->get();
    // code 参数是从 /index/index/home 页面传递过来的，加密了需要的参数。但是没有对 business_id 做校验，即使为空也会允许访问
    // 最后在 application\admin\controller\Event.php 文件中，会弹出提示【该分类客服都不在线】
    $data = $common->encrypt($arr['code'], 'D', 'wolive');
    parse_str($data, $arr2);
    // 没有访客ID时，自动生成，并且存到Session中
    if ($visiter_id === '') {
        if (empty($_SESSION['Custom']['visiter_id'])) {
            $visiter_id = bin2hex(pack('N', time()));
            $_SESSION['Custom']['visiter_id'] = $visiter_id;
        } else {
            $visiter_id = $_SESSION['Custom']['visiter_id'];
        }
    }

    // 访客发送产品信息给客服的相关逻辑
    // ... 一坨翔的代码，=_= 还有完全多余的 if($visiter_id) 晕倒啊
    // 大概就是获取参数传递的产品信息，发送给客服

    $channel = bin2hex($visiter_id . '/' . $business_id);
    $visiter_name = htmlspecialchars($arr2['visiter_name']);
    $avatar = htmlspecialchars($arr2['avatar']);
    if ($visiter_name == '') {
        $visiter_name = '游客' . $visiter_id;
    }
    $groupid = htmlspecialchars($arr2['groupid']);

    $business = User::table('wolive_business')->where('id', $business_id)->find();
    $rest = RestSetting::get(['business_id'=>$business_id]);
    $state = empty($rest) ? false : $rest->isOpen($business_id,$visiter_id) ;
    //... 赋值变量
    return $this->fetch();
}

// application\index\view\index\index.html 对话窗口页面模板
// 首页有视频和语音通话的发起，但是我没有看到。
// 这个页面定义了 wolive_connect，然后在 public\assets\js\index\inchat.js 里调用了。  
<script>
  var mediaStreamTrack;
      var visiter ='{$visiter}';
      var business_id  ='{$business_id}';
      var record='{$from_url}';
      record.replace("%23","#");
      record.replace("%26","&");
      var pic ='{$avatar}';
      var channel= '{$channel}';
      var visiter_id= '{$visiter_id}';
      var special = '{$special}';
      var url ='{$url}';
      var cid ='{$groupid}';
      var pic ='{$avatar}';
      if (pic == "") {
          pic = "__image__/index/avatar-red2.png";
      }

      var service_id=0;
      var num;
      var t;

      var hintstate;
      var myTitle = document.title;

      var isActive;

      window.onfocus = function () {
        isActive = true;
        clearTimeout(t);
        document.title =myTitle;
      };

          window.onblur = function () {
            num=0;
            isActive = false;
          };

      // 网页标题变化，通过不断修改来实现标题切换的效果
      function title(){
            num++;
            if(num == 3){
              num =1;
            }
            if(num == 1){
              document.title='【】'+myTitle;
            }
            if(num ==2){
              document.title='【你有一条消息】'+myTitle;
            }
            t= setTimeout("title()",500);
        }

      var wolive_connect =function () {

          pusher = new Pusher('{$app_key}', {
              encrypted: {$value}
              ,enabledTransports: ['ws']
              ,wsHost: '{$whost}'
              ,{$port}: {$wport}
              ,authEndpoint: HJWEB_ROOT_URL + '/admin/login/auth'
              ,disableStats: true
        });

          var channels = pusher.subscribe("cu" + channel);

          // 接收消息
          channels.bind('my-event', function (data) {

              if(!isActive){
                  title();
              }

              if($.cookie('state') == 'on'){
                  audioElementHovertree = document.createElement('audio');
                  audioElementHovertree.setAttribute('src', "/upload/voice/default.mp3");
                  audioElementHovertree.setAttribute('autoplay', 'autoplay');
              }

              var msg = '';
              msg += '<li class="chatmsg"><div style="position: absolute;left:3px;">';
              msg += '<img class="my-circle  se_pic" src="' + data.message.avatar + '" width="40px" height="40px"></div>';
              msg += "<div class='outer-left'><div class='service'>";
              msg += "<pre>" + data.message.content + "</pre>";
              msg += "</div></div>";
              msg += "</li>";
              $(".conversation").append(msg);
              var div = document.getElementById("wrap");
              div.scrollTop = div.scrollHeight;
              setTimeout(function(){
                  $('.chatmsg').css({
                      height: 'auto'
                  });
              },0)
          });

          channels.bind('push-comment',function(data){
              var html = '<div style="margin-bottom: 20px;">'+data.message.title+'</div>';
              $.each(data.message.comments,function(index,value){
                  html += '<div data-score="0" class=\'evaluate-item evaluate-score\'>\n' +
                      '                        <span class="evaluate-title">'+ value +'</span>\n' +
                      '                        <input type="hidden" name="'+value+'"></input>\n' +
                      '                        <img class="star" data-id="1" src="__image__/index/star.png" alt="">\n' +
                      '                        <img class="star" data-id="2" src="__image__/index/star.png" alt="">\n' +
                      '                        <img class="star" data-id="3" src="__image__/index/star.png" alt="">\n' +
                      '                        <img class="star" data-id="4" src="__image__/index/star.png" alt="">\n' +
                      '                        <img class="star" data-id="5" src="__image__/index/star.png" alt="">\n' +
                      '                        <span class="evaluate-text"></span>\n' +
                      '                        </div>'
              });

              if (data.message.word_switch == 'open') {
                  html += ' <div class=\'evaluate-item\' style="height: 80px;line-height: 1;margin-top: 10px;align-items: flex-start">\n' +
                      '                <span class="evaluate-title">'+ data.message.word_title +'</span>\n' +
                      '                <textarea class="about-text" name="" id="" cols="30" rows="5"></textarea>\n' +
                      '            </div>';
              }

              html += '<div class="evaluate-btn">\n' +
                  '                <button class="submit">提交</button>\n' +
                  '                <button class="reset">取消</button>\n' +
                  '            </div>';
              $('.bg .dialog-body').html(html);
              $('.bg').show();
          });

          channels.bind('first_word',function(data){
              var msg = '';
              msg += '<li class="chatmsg_no"><div style="position: absolute;left:3px;">';
              msg += '<img class="my-circle  se_pic" src="' + data.message.avatar + '" width="40px" height="40px"></div>';
              msg += "<div class='outer-left'><div class='service'>";
              msg += "<pre>" + data.message.content + "</pre>";
              msg += "</div></div>";
              msg += "</li>";

              $(".conversation").append(msg);
          });
          // 接受视频请求
          channels.bind("video",function (data) {
              var msg = data.message;
              var cha = data.channel;
              var avatar =data.avatar;
              var username =data.username;

              layer.open({
                  type: 1,
                  title: '申请框',
                  area: ['260px', '160px'],
                  shade: 0.01,
                  fixed: true,
                  btn: ['接受', '拒绝'],
                  content: "<div style='position: absolute;left:20px;top:15px;'><img src='"+avatar+"' width='40px' height='40px' style='border-radius:40px;position:absolute;left:5px;top:5px;'><span style='width:100px;position:absolute;left:70px;top:5px;font-size:13px;overflow-x: hidden;'>"+username+"</span><div style='width:90px;height:20px;position:absolute;left:70px;top:26px;'>"+msg+"</div></div>",
                  yes: function () {
                      layer.closeAll('page');

                      var str='';
                      str+='<div class="videos">';
                      str+='<video id="localVideo" autoplay></video>';
                      str+='<video id="remoteVideo" autoplay class="hidden"></video></div>';


                      layer.open({
                        type:1
                        ,title: '视频'
                        ,shade:0
                        ,closeBtn:1
                        ,area: ['440px', '378px']
                        ,content:str
                        ,end:function(){


                            mediaStreamTrack.getTracks().forEach(function (track) {
                              track.stop();
                          });

                        }
                    });

                      try{
                          connenctVide(cha);
                      }catch(e){
                          console.log(e);
                      }

                  },
                  btn2:function(){
                      var sid =$.cookie('services');
                      $.ajax({
                          url:HJWEB_ROOT_URL+'/admin/event/refuse',
                          type:'post',
                          data:{id:sid}
                      });

                      layer.closeAll('page');
                  }
              });
          });

          // 接受拒绝视频请求
          channels.bind("video-refuse",function (data) {
              layer.alert(data.message);

              layer.closeAll('page');
          });

          // 认领通知
          channels.bind('cu_notice', function (data) {

              $("#img_head").attr("src", data.message.avatar);
              $("#services").text(data.message.nick_name);
              $(".chatmsg_notice").remove();
              $(".chatmsg").remove();
              $.cookie("services",data.message.service_id);
              service_id =data.message.service_id;

              getdata();
              getlisten(data.message.service_id);
          });


          channels.bind('getswitch', function (data) {

              $("#img_head").attr("src", data.message.avatar);
              $("#services").text(data.message.nick_name);
              $("#services").attr("data", data.message.service_id);
              service_id = data.message.service_id;

              var msg = '';
              msg += '<li class="chatmsg"><div style="position: absolute;left:3px;">';
              msg += '<img class="my-circle  se_pic" src="' + data.message.avatar + '" width="40px" height="40px"></div>';
              msg += "<div class='outer-left'><div class='service'>";
              msg += "<pre> 已经将您转接到其他客服  " + data.message.nick_name + "</pre>";
              msg += "</div></div>";
              msg += "</li>";
              $(".conversation").append(msg);

          });

          if( $.cookie("services")){
              getlisten($.cookie('services'));
          }


          function getlisten(chas){

              var channels = pusher.subscribe("se"+chas);

              //通知游客 客服离线
              channels.bind('logout', function (data) {
                  $("#img_head").addClass("icon_gray");

              });

              //表示客服在线
              channels.bind("geton", function (data) {
                  $("#img_head").removeClass("icon_gray");

              });
            }

          pusher.connection.bind('state_change', function(states) {
              if(states.current == 'unavailable' || states.current == "disconnected" || states.current == "failed" ){
                  $.cookie("cid","");
                  var id =$.cookie("services");
                  if(id){
                    pusher.unsubscribe("se"+id);
                  }
                  pusher.unsubscribe("cu" + channel);

                  if (typeof pusher.isdisconnect == 'undefined') {
                  pusher.isdisconnect = true;
                  pusher.disconnect();
                    delete pusher;
                  window.setTimeout(function(){
                      wolive_connect();
                  },1000);
                }
              }
          });

          pusher.connection.bind('connected', function() {
              $.cookie("cid","");
          });
      }
  </script>


// public\assets\js\index\inchat.js
var init = function () {
    types();
    $.cookie("cid", '');
    wolive_connect(); // 发起 websocket 连接
    getquestion(business_id);
    gettab(business_id);
    // 获取欢迎语，以及检测客服状态
    $.ajax({
        url: HJWEB_ROOT_URL + "/admin/event/notice",
        type: 'post',
        data: { visiter_id: visiter_id, visiter_name: visiter, business_id: business_id, from_url: record, avatar: pic, groupid: cid, special: special },
        success: function (res) {
            if (res.code == 0) {
              ...发送欢迎语
            } else if (res.code == 1) {
                layer.msg(res.msg, { icon: 2 });
            } else if (res.code == 2) {
              ...客服接待访客过多，排队中
            } else if (res.code == 3) {
              ...页面跳转
            } else if (res.code == 4) {
              ...该客服离线，是否转接其他客服
            }
        }
    });
}  
```

### 迷你窗口

```js
// 文件地址 public\assets\layer\dianqilai_1.js
connenct:function(groupid){
  var id =groupid;
  var web =encodeURI('http://customerservice.test/layer?visiter_id='+this.visiter_id+'&visiter_name='+this.visiter_name+'&avatar='+this.avatar+'&business_id=1&groupid='+groupid+'&product='+this.product);

  .....
  div.innerHTML='<i class="dianqilai-close" onclick="dianqilai.narrow()"></i><iframe id="wolive-iframe" src="'+web+'"></iframe>'
},
// 最后访问到 /layer/index/index
// 迷你窗口手机端没有差异，只有PC端有不同
// PC端利用 iframe 来加载第三方网站地址，非常的优秀。
```
